# project source
TOPNAME = PvuTop
VSRCS += $(shell find $(abspath ./vsrc) -name "*.sv")
CSRCS += $(shell find $(abspath ./csrc) -name "*.cpp")
CONFIG_H = config.h

# verilator flags
VERILATOR_FLAGS += -Wall --cc --trace --exe --build --top-module $(TOPNAME)
VERILATOR_FLAGS += -Wno-DECLFILENAME -Wno-PINCONNECTEMPTY -Wno-UNUSEDSIGNAL -Wno-UNOPTFLAT
VERILATOR_FLAGS += --threads-dpi all
VERILATOR_FLAGS += -j 16

include .config

$(CONFIG_H): .config
	@echo "/* Auto-generated by Makefile from .config */" > $(CONFIG_H)
	@echo "#ifndef CONFIG_H" >> $(CONFIG_H)
	@echo "#define CONFIG_H" >> $(CONFIG_H)
	@echo "" >> $(CONFIG_H)
	@awk 'BEGIN { FS="="; OFS=" "; } \
		/^[^#]/ { \
			if ($$2 == "y") { \
				print "#define", $$1, "1"; \
			} else if ($$2 == "n" || $$2 == "") { \
				print "#define", $$1, "0"; \
			} \
		}' .config >> $(CONFIG_H)

	@echo "#endif // CONFIG_H" >> $(CONFIG_H)


verilog:
	sbt -DparallelExecution=true -DmaxThreads=16 "runMain pvu.Elaborate"
	python3 clean_line.py

run:${CSRCS} ${VSRCS}
	verilator ${VERILATOR_FLAGS} ${CSRCS} ${VSRCS}
	./obj_dir/VPvuTop

wave:
	gtkwave pvu_top_wave.vcd

git:
	git add .
	git commit

push:
	git push

menuconfig:
	menuconfig
	make config.h

count:
	@echo "Number of Scala files:"
	@echo $(shell find . -type f -name "*.scala" | wc -l)
	@echo "Total lines of Scala code:"
	@echo $(shell find src -name "*.scala" -type f | xargs cat | wc -l)
	@echo "Total lines of Verilog code:"
	@echo $(shell find vsrc -name "*.sv" -type f | xargs cat | wc -l)


debug:
	make verilog
	make run

